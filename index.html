<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SUGA - Sistema Unificado de Gestão Administrativa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (to compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (Compat version for single file usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- XLSX (SheetJS) for Excel Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              suga: {
                dark: '#144638', // Dark green
                medium: '#1B5E4A',
                light: '#F0F9F4', // Background light green
                accent: '#FFFACD', // Input yellow background
                text: '#1F2937'
              }
            }
          }
        }
      }
    </script>

    <!-- Custom Styles -->
    <style>
      body {
        background-color: #F0F9F4;
        font-family: 'Inter', sans-serif;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1; 
      }
      ::-webkit-scrollbar-thumb {
        background: #ccc; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #144638; 
      }
      
      /* Animations */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fadeIn 0.4s ease-out forwards;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.8.0/",
    "xlsx": "https://esm.sh/xlsx@^0.18.5"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- FIREBASE CONFIGURATION & SHIMS ---
      const firebaseConfig = {
        apiKey: "AIzaSyA6JvmOJ5FbEDjw2pgZFcemdvh_Zo6C7aM",
        authDomain: "suga-adm.firebaseapp.com",
        projectId: "suga-adm",
        storageBucket: "suga-adm.firebasestorage.app",
        messagingSenderId: "207680956582",
        appId: "1:207680956582:web:411220f21abc478ccd2c67",
        measurementId: "G-ERCKT3ERSN"
      };

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.firestore();

      // --- SHIMS TO MAKE MODULAR CODE WORK WITH COMPAT SDK ---
      const collection = (dbInstance, path) => dbInstance.collection(path);
      const doc = (dbInstance, path, id) => id ? dbInstance.collection(path).doc(id) : dbInstance.doc(path);
      const addDoc = (ref, data) => ref.add(data);
      const deleteDoc = (ref) => ref.delete();
      const updateDoc = (ref, data) => ref.update(data);
      const Timestamp = firebase.firestore.Timestamp;
      
      const query = (ref, ...constraints) => {
        let q = ref;
        constraints.forEach(c => {
          if (c.type === 'orderBy') q = q.orderBy(c.field, c.direction);
        });
        return q;
      };
      const orderBy = (field, direction) => ({ type: 'orderBy', field, direction });
      
      const onSnapshot = (queryRef, callback) => {
        return queryRef.onSnapshot(callback);
      };

      const signInWithEmailAndPassword = (authInstance, email, pass) => {
        return authInstance.signInWithEmailAndPassword(email, pass);
      };
      const signOut = (authInstance) => authInstance.signOut();
      const onAuthStateChanged = (authInstance, callback) => authInstance.onAuthStateChanged(callback);


      // --- COMPONENTS ---

      // 1. HighlightText Component
      const HighlightText = ({ text, highlight }) => {
        const val = text || '';
        if (!highlight || !highlight.trim()) {
          return <span>{val}</span>;
        }

        const escapeRegExp = (string) => {
          return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        };

        const regex = new RegExp(`(${escapeRegExp(highlight)})`, 'gi');
        const parts = val.split(regex);

        return (
          <span>
            {parts.map((part, i) => 
              part.toLowerCase() === highlight.toLowerCase() ? (
                <span key={i} className="bg-yellow-300 text-black font-extrabold px-0.5 rounded-sm shadow-sm border-b-2 border-yellow-500">{part}</span>
              ) : (
                <span key={i}>{part}</span>
              )
            )}
          </span>
        );
      };

      // 2. Footer Component
      const Footer = () => (
        <footer className="bg-white py-4 px-6 border-t border-gray-100 mt-auto">
          <div className="flex items-center justify-between max-w-7xl mx-auto w-full">
            <div className="flex items-center gap-2">
              <div className="h-2 w-2 rounded-full bg-emerald-400"></div>
              <span className="text-[10px] text-gray-500 font-bold tracking-widest uppercase">
                Desenvolvido por <span className="text-suga-dark">Jairton Filho</span> © 2025
              </span>
            </div>
            <div className="flex items-center gap-2 text-gray-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="opacity-50">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
              <span className="text-[10px] font-bold">JAIRTONTECH</span>
            </div>
          </div>
        </footer>
      );

      // 3. Login Component
      const Login = () => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleLogin = async (e) => {
          e.preventDefault();
          setLoading(true);
          setError('');

          try {
            await signInWithEmailAndPassword(auth, email, password);
          } catch (err) {
            console.error(err);
            setError('Credenciais inválidas. Tente novamente.');
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="w-full max-w-md animate-fade-in">
            <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
              <div className="bg-suga-dark p-8 pb-10 text-center flex flex-col items-center">
                <div className="w-16 h-16 border-2 border-white/20 rounded-xl flex items-center justify-center mb-4 bg-white/5 backdrop-blur-sm">
                  <span className="text-white font-black text-xl tracking-tighter">SUGA</span>
                </div>
                <h1 className="text-white font-bold text-lg tracking-wide uppercase">
                  Sistema Unificado de Gestão Administrativa
                </h1>
              </div>

              <div className="p-8 pt-6">
                <form onSubmit={handleLogin} className="space-y-5">
                  <div>
                    <label className="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Usuário</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="exemplo@suga.com"
                      className="w-full bg-suga-accent text-gray-800 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-suga-dark/50 font-medium"
                      required
                    />
                  </div>
                  
                  <div>
                    <label className="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Senha</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="•••••"
                      className="w-full bg-suga-accent text-gray-800 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-suga-dark/50 font-medium tracking-widest"
                      required
                    />
                  </div>

                  {error && (
                    <p className="text-red-500 text-xs text-center font-semibold">{error}</p>
                  )}

                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-suga-dark hover:bg-suga-medium text-white font-bold py-3 px-4 rounded-lg uppercase text-xs tracking-wider transition-all shadow-lg shadow-emerald-900/20 disabled:opacity-70 mt-4"
                  >
                    {loading ? 'Autenticando...' : 'Autenticar'}
                  </button>
                </form>

                <div className="flex justify-between mt-8 text-[10px] font-bold text-gray-400 uppercase">
                  <button className="hover:text-suga-dark transition-colors">Solicitar Registro</button>
                  <button className="hover:text-suga-dark transition-colors">Recuperar Acesso</button>
                </div>

                <div className="mt-8 pt-4 border-t border-gray-100 flex justify-between items-center">
                  <div className="flex gap-1.5">
                    <span className="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                    <span className="h-1.5 w-1.5 rounded-full bg-gray-200"></span>
                    <span className="h-1.5 w-1.5 rounded-full bg-gray-200"></span>
                  </div>
                  <span className="text-[9px] text-gray-300 font-bold">SUGA V4.9 STABLE</span>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // 4. StatusBadge Component
      const StatusBadge = ({color, label}) => (
        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full ${color}`}>
          <div className="w-1.5 h-1.5 rounded-full bg-current"></div>
          <span className="text-[9px] font-extrabold tracking-wide">{label}</span>
        </div>
      );

      // 5. Dashboard Component
      const Dashboard = ({ navigate }) => {
        return (
          <div className="flex flex-col items-center justify-center min-h-[60vh] animate-fade-in">
            <div className="text-center mb-12">
              <h1 className="text-4xl md:text-5xl font-black text-suga-dark uppercase tracking-tight mb-2">
                Painel de Controle
              </h1>
              <h2 className="text-lg md:text-xl font-bold text-slate-600 mb-2">
                BEM-VINDO AO SISTEMA UNIFICADO DE GESTÃO ADMINISTRATIVA
              </h2>
              <p className="text-xs font-bold text-gray-400 tracking-[0.2em] uppercase">
                Escolha uma das opções abaixo para prosseguir
              </p>
            </div>

            <div className="flex gap-4 mb-12">
              <StatusBadge color="bg-emerald-100 text-emerald-700" label="MÓDULO RH ONLINE" />
              <StatusBadge color="bg-orange-100 text-orange-700" label="SUÍTE SINCRONIZADO" />
              <StatusBadge color="bg-blue-100 text-blue-700" label="SERVIDOR ESTÁVEL" />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl px-4">
              {/* Card 1: Pessoal */}
              <div 
                onClick={() => navigate('personnel')}
                className="bg-white rounded-3xl p-8 shadow-sm hover:shadow-xl transition-all cursor-pointer group border border-transparent hover:border-emerald-100"
              >
                <div className="bg-emerald-50 w-14 h-14 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                   <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-suga-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </div>
                <div className="flex items-center gap-3 mb-2">
                  <h3 className="text-2xl font-black text-gray-800 uppercase">Relação do Pessoal</h3>
                  <span className="bg-suga-dark text-white text-[10px] font-bold px-2 py-0.5 rounded-full">ACESSO TOTAL</span>
                </div>
                <p className="text-xs font-bold text-gray-400 uppercase leading-relaxed max-w-xs">
                  Gestão organizacional dos servidores e colaboradores das unidades operacionais CPSB
                </p>
              </div>

              {/* Card 2: Processos */}
              <div 
                 onClick={() => navigate('processes')}
                 className="bg-white rounded-3xl p-8 shadow-sm hover:shadow-xl transition-all cursor-pointer group border border-transparent hover:border-emerald-100"
              >
                <div className="bg-orange-50 w-14 h-14 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div className="flex items-center gap-3 mb-2">
                  <h3 className="text-2xl font-black text-gray-800 uppercase">Processos Suite</h3>
                </div>
                <p className="text-xs font-bold text-gray-400 uppercase leading-relaxed">
                  Consulta NUP dos processos gerados
                </p>
              </div>
            </div>
          </div>
        );
      };

      // 6. PersonnelList Component
      const PersonnelList = ({ navigate }) => {
        const sectors = [
          "CPSB", "CEPP", "CENTRO COMUNITÁRIO FAROL", "CENTRO COMUNITÁRIO SÃO VICENTE",
          "CENTRO COMUNITÁRIO SANTA TEREZINHA", "CENTRO COMUNITÁRIO SÃO FRANCISCO", "ESPAÇO VIVA GENTE",
          "ABC SERRINHA", "ABC MONDUBIM", "ABC CAJUEIRO TORTO", "ABC BOM JARDIM", "ABC PALMEIRAS",
          "CIRCO BOM JARDIM", "CIRCO PALMEIRAS"
        ];

        return (
          <div className="animate-fade-in">
            <div className="flex items-center gap-4 mb-8">
              <button 
                onClick={() => navigate('dashboard')}
                className="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-gray-600 hover:text-suga-dark hover:shadow-md transition-all"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
              </button>
              <div>
                <h1 className="text-2xl font-black text-gray-800 uppercase">Relação do Pessoal</h1>
                <p className="text-[10px] font-bold text-green-500 uppercase tracking-widest">Selecione Setor</p>
              </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              {sectors.map((sector, index) => (
                <div key={index} className="bg-white p-6 rounded-2xl shadow-sm hover:shadow-lg transition-all cursor-pointer group h-40 flex flex-col justify-between">
                  <h3 className="font-extrabold text-gray-800 text-sm uppercase">{sector}</h3>
                  <span className="text-[10px] font-bold text-green-500 uppercase opacity-0 group-hover:opacity-100 transition-opacity">
                    Acessar
                  </span>
                </div>
              ))}
            </div>
          </div>
        );
      };

      // 7. ProcessSuite Component (The Main Logic)
      const ProcessSuite = ({ navigate, user }) => {
        const [processes, setProcesses] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [loading, setLoading] = useState(true);
        const [importing, setImporting] = useState(false);
        const [editingId, setEditingId] = useState(null);
        const [selectedIds, setSelectedIds] = useState([]);
        
        // Define Permissions
        const role = user?.role;
        const canWrite = role === 'admin' || role === 'operador';
        const canDelete = role === 'admin';

        // Form State
        const [formData, setFormData] = useState({
          data: new Date().toISOString().split('T')[0],
          nup: '',
          description: ''
        });

        const fileInputRef = useRef(null);

        useEffect(() => {
          // Using shimmed query and collection
          const q = query(collection(db, 'processes'), orderBy('data', 'desc'));
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const docs = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            setProcesses(docs);
            setLoading(false);
          });

          return () => unsubscribe();
        }, []);

        const handleOpenNew = () => {
          setEditingId(null);
          setFormData({
            data: new Date().toISOString().split('T')[0],
            nup: '',
            description: ''
          });
          setIsModalOpen(true);
        };

        const handleOpenEdit = (process) => {
          setEditingId(process.id);
          setFormData({
            data: process.data,
            nup: process.nup,
            description: process.description
          });
          setIsModalOpen(true);
        };

        const handleSave = async (e) => {
          e.preventDefault();
          try {
            if (editingId) {
              // Update existing record
              const docRef = doc(db, 'processes', editingId);
              await updateDoc(docRef, {
                data: formData.data,
                nup: formData.nup,
                description: formData.description
              });
            } else {
              // Create new record
              await addDoc(collection(db, 'processes'), {
                data: formData.data,
                nup: formData.nup,
                description: formData.description,
                createdAt: Timestamp.now()
              });
            }
            setIsModalOpen(false);
            setFormData({
              data: new Date().toISOString().split('T')[0],
              nup: '',
              description: ''
            });
          } catch (error) {
            console.error("Error saving document: ", error);
            alert("Erro ao salvar o registro.");
          }
        };

        const handleDelete = async (id) => {
          if (window.confirm('Tem certeza que deseja excluir este registro?')) {
            try {
              await deleteDoc(doc(db, 'processes', id));
               // Remove from selection if it was selected
              if (selectedIds.includes(id)) {
                setSelectedIds(selectedIds.filter(itemId => itemId !== id));
              }
            } catch (error) {
              console.error("Error deleting document: ", error);
              alert("Erro ao excluir o registro. Verifique suas permissões.");
            }
          }
        };

        const handleBulkDelete = async () => {
          if (!canDelete) return;
          const confirmMessage = selectedIds.length === 1 
            ? 'Tem certeza que deseja excluir o registro selecionado?' 
            : `Tem certeza que deseja excluir os ${selectedIds.length} registros selecionados?`;

          if (window.confirm(confirmMessage)) {
            try {
              const deletePromises = selectedIds.map(id => deleteDoc(doc(db, 'processes', id)));
              await Promise.all(deletePromises);
              setSelectedIds([]);
              alert('Registros excluídos com sucesso.');
            } catch (error) {
              console.error("Error deleting documents: ", error);
              alert("Erro ao excluir registros. Verifique suas permissões.");
            }
          }
        };

        const handleFileUpload = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          setImporting(true);
          const reader = new FileReader();
          reader.onload = async (evt) => {
            try {
              // Changed: Use readAsArrayBuffer for better ODS/Excel compatibility
              const ab = evt.target?.result;
              // IMPORTANT: cellDates: true helps recognize dates correctly
              const wb = XLSX.read(ab, { type: 'array', cellDates: true });
              const wsname = wb.SheetNames[0];
              const ws = wb.Sheets[wsname];
              const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
              
              let importedCount = 0;
              const batchPromises = [];

              // Helper function to robustly parse dates from Excel/ODS
              const parseDate = (val) => {
                if (!val) return new Date().toISOString().split('T')[0];
                
                // 1. Handle JS Date Objects (from cellDates: true)
                if (val instanceof Date) {
                  // Use getFullYear/Month/Date to avoid UTC shifts
                  const year = val.getFullYear();
                  const month = String(val.getMonth() + 1).padStart(2, '0');
                  const day = String(val.getDate()).padStart(2, '0');
                  return `${year}-${month}-${day}`;
                }

                // 2. If number (Excel/LibreOffice serial date) fallback
                if (typeof val === 'number') {
                   // Adjust for Excel/LibreOffice date serial
                   const date = new Date(Math.round((val - 25569)*86400*1000));
                   date.setHours(12); // Safe buffer for timezone
                   if (!isNaN(date.getTime())) {
                     const year = date.getFullYear();
                     const month = String(date.getMonth() + 1).padStart(2, '0');
                     const day = String(date.getDate()).padStart(2, '0');
                     return `${year}-${month}-${day}`;
                   }
                }
                
                // 3. If string, try to parse
                if (typeof val === 'string') {
                   const trimmed = val.trim();

                   // PT-BR Format DD/MM/YYYY or DD-MM-YYYY
                   const ptBrMatch = trimmed.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
                   if (ptBrMatch) {
                      const day = ptBrMatch[1].padStart(2, '0');
                      const month = ptBrMatch[2].padStart(2, '0');
                      let year = ptBrMatch[3];
                      if (year.length === 2) year = '20' + year; 
                      return `${year}-${month}-${day}`;
                   }

                   // ISO Format YYYY-MM-DD
                   const isoMatch = trimmed.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
                   if (isoMatch) {
                      const year = isoMatch[1];
                      const month = isoMatch[2].padStart(2, '0');
                      const day = isoMatch[3].padStart(2, '0');
                      return `${year}-${month}-${day}`;
                   }
                   
                   // Fallback standard parse
                   const date = new Date(val);
                   if (!isNaN(date.getTime())) return date.toISOString().split('T')[0];
                }
                
                // Fallback to today
                return new Date().toISOString().split('T')[0];
              };

              for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row && row.length > 0) {
                  // Assume Column A: Date, B: NUP, C: Description
                  const rawDate = row[0];
                  const rawNup = row[1];
                  const rawDesc = row[2];

                  const dateStr = parseDate(rawDate);
                  const nupStr = String(rawNup || '');
                  const descStr = String(rawDesc || '');

                  if (nupStr.trim() || descStr.trim()) {
                     batchPromises.push(addDoc(collection(db, 'processes'), {
                        data: dateStr,
                        nup: nupStr,
                        description: descStr,
                        createdAt: Timestamp.now()
                     }));
                     importedCount++;
                  }
                }
              }
              
              await Promise.all(batchPromises);
              alert(`${importedCount} registros importados com sucesso!`);
            } catch (error) {
              console.error("Import error:", error);
              alert("Erro ao processar arquivo. Verifique se o arquivo não está corrompido e se é um formato válido.");
            } finally {
              setImporting(false);
              if (fileInputRef.current) fileInputRef.current.value = '';
            }
          };
          reader.readAsArrayBuffer(file);
        };

        const filteredProcesses = processes.filter(p => 
          p.nup.toLowerCase().includes(searchTerm.toLowerCase()) ||
          p.description.toLowerCase().includes(searchTerm.toLowerCase())
        );

        const handleSelectAll = (e) => {
          if (e.target.checked) {
            setSelectedIds(filteredProcesses.map(p => p.id));
          } else {
            setSelectedIds([]);
          }
        };

        const handleSelectOne = (id) => {
          if (selectedIds.includes(id)) {
            setSelectedIds(selectedIds.filter(itemId => itemId !== id));
          } else {
            setSelectedIds([...selectedIds, id]);
          }
        };

        const handleExport = () => {
          const itemsToExport = selectedIds.length > 0 
            ? filteredProcesses.filter(p => selectedIds.includes(p.id))
            : filteredProcesses;

          const dataToExport = itemsToExport.map(p => ({
            'Data': p.data ? new Date(p.data + 'T12:00:00').toLocaleDateString('pt-BR') : '',
            'NUP': p.nup,
            'Descrição': p.description
          }));

          const ws = XLSX.utils.json_to_sheet(dataToExport);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Processos");
          const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
          const fileName = selectedIds.length > 0 
            ? `SUGA_Processos_Selecionados_${dateStr}.xlsx`
            : `SUGA_Processos_Geral_${dateStr}.xlsx`;

          XLSX.writeFile(wb, fileName);
        };

        return (
          <div className="relative max-w-[1600px] mx-auto">
            {/* Wrapper animado para o conteúdo (Header e Tabela) */}
            <div className="animate-fade-in">
              
              {/* Header Bar */}
              <div className="flex flex-col xl:flex-row xl:items-center justify-between gap-6 mb-8">
                <div className="flex items-center gap-5">
                  <button 
                    onClick={() => navigate('dashboard')}
                    className="w-12 h-12 bg-white rounded-2xl shadow-sm flex items-center justify-center text-gray-400 hover:text-suga-dark hover:shadow-md transition-all shrink-0 border border-transparent hover:border-gray-100"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <div>
                    <h1 className="text-3xl font-black text-gray-800 uppercase tracking-tight leading-none mb-1">Processos Suite</h1>
                    <div className="flex gap-2 items-center">
                      <p className="text-[11px] font-bold text-blue-500 uppercase tracking-[0.2em]">Total: {processes.length}</p>
                      {selectedIds.length > 0 && (
                        <span className="text-[11px] font-bold text-suga-dark uppercase tracking-[0.2em] bg-emerald-100 px-2 rounded-full">
                          Selecionados: {selectedIds.length}
                        </span>
                      )}
                    </div>
                  </div>
                </div>

                <div className="flex flex-wrap gap-3 items-center">
                  <div className="relative group">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <svg className="h-4 w-4 text-gray-400 group-focus-within:text-emerald-500 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" />
                      </svg>
                    </div>
                    <input 
                      type="text" 
                      placeholder="Filtrar processos..." 
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="pl-10 pr-4 bg-white border border-gray-200 rounded-lg py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent min-w-[280px] shadow-sm transition-all font-medium text-gray-600"
                    />
                  </div>
                  
                  {/* Export Button */}
                  <button 
                    onClick={handleExport}
                    className="bg-white border border-gray-300 text-gray-700 hover:border-emerald-600 hover:text-emerald-600 font-bold text-xs px-5 py-2.5 rounded-lg uppercase transition-all shadow-sm flex items-center gap-2.5 whitespace-nowrap"
                    title={selectedIds.length > 0 ? "Exportar Selecionados" : "Exportar Todos"}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    {selectedIds.length > 0 ? `Exportar (${selectedIds.length})` : "Exportar"}
                  </button>

                  {canWrite && (
                    <>
                      <input 
                        type="file" 
                        ref={fileInputRef}
                        onChange={handleFileUpload}
                        accept=".xlsx,.xls,.ods,.csv,.xlsb,.xlsm,.xml,.fods"
                        className="hidden"
                      />
                      
                      {/* Import Button */}
                      <button 
                        onClick={() => fileInputRef.current?.click()}
                        disabled={importing}
                        className="bg-white border border-gray-300 text-gray-700 hover:border-suga-dark hover:text-suga-dark font-bold text-xs px-5 py-2.5 rounded-lg uppercase transition-all shadow-sm flex items-center gap-2.5 whitespace-nowrap"
                      >
                        {importing ? (
                          <span className="animate-spin h-3.5 w-3.5 border-2 border-suga-dark border-t-transparent rounded-full"></span>
                        ) : (
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        )}
                        Importar
                      </button>

                      {/* New Record Button */}
                      <button 
                        type="button"
                        onClick={handleOpenNew}
                        className="bg-suga-dark hover:bg-emerald-800 text-white font-bold text-xs px-6 py-2.5 rounded-lg uppercase transition-all shadow-lg shadow-emerald-900/20 whitespace-nowrap flex items-center gap-2"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Novo Registro
                      </button>
                    </>
                  )}

                  {/* Delete Button (Conditional) */}
                  {canDelete && selectedIds.length > 0 && (
                     <button 
                      onClick={handleBulkDelete}
                      className="bg-red-50 border border-red-200 text-red-600 hover:bg-red-100 hover:border-red-300 font-bold text-xs px-5 py-2.5 rounded-lg uppercase transition-all shadow-sm flex items-center gap-2.5 whitespace-nowrap"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                      Excluir ({selectedIds.length})
                    </button>
                  )}
                </div>
              </div>

              {/* Main Table Area */}
              <div className="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
                {/* Table Header */}
                <div className="grid grid-cols-12 gap-6 px-8 py-5 bg-gray-50/50 border-b border-gray-100 text-[11px] font-extrabold text-gray-400 uppercase tracking-widest select-none">
                  {/* Checkbox Column */}
                  <div className="col-span-1 flex items-center">
                    <input 
                      type="checkbox"
                      className="w-4 h-4 rounded text-suga-dark focus:ring-suga-dark cursor-pointer accent-suga-dark"
                      onChange={handleSelectAll}
                      checked={filteredProcesses.length > 0 && selectedIds.length === filteredProcesses.length}
                    />
                  </div>
                  <div className="col-span-2">Data</div>
                  <div className="col-span-2">NUP</div>
                  <div className="col-span-5">Descrição do Fluxo</div>
                  <div className="col-span-2 text-right">Ações</div>
                </div>

                {/* Table Content */}
                {loading ? (
                  <div className="flex flex-col items-center justify-center h-80">
                    <div className="animate-spin rounded-full h-10 w-10 border-4 border-gray-100 border-t-suga-dark mb-4"></div>
                    <span className="text-xs font-bold text-gray-300 uppercase tracking-widest">Carregando dados...</span>
                  </div>
                ) : filteredProcesses.length > 0 ? (
                  <div className="divide-y divide-gray-50">
                    {filteredProcesses.map((process) => (
                      <div key={process.id} className={`grid grid-cols-12 gap-6 px-8 py-6 items-center transition-colors group ${selectedIds.includes(process.id) ? 'bg-emerald-50/60' : 'hover:bg-emerald-50/20'}`}>
                        {/* Checkbox Row */}
                        <div className="col-span-1 flex items-center">
                           <input 
                            type="checkbox"
                            className="w-4 h-4 rounded text-suga-dark focus:ring-suga-dark cursor-pointer accent-suga-dark"
                            checked={selectedIds.includes(process.id)}
                            onChange={() => handleSelectOne(process.id)}
                          />
                        </div>
                        <div className="col-span-2">
                           <div className="text-xs font-semibold text-gray-500">
                            {process.data ? new Date(process.data + 'T12:00:00').toLocaleDateString('pt-BR') : '-'}
                           </div>
                        </div>
                        <div className="col-span-2">
                          <div className="text-xs font-bold text-emerald-700 font-mono tracking-tight" title={process.nup}>
                            <HighlightText text={process.nup || 'Sem NUP'} highlight={searchTerm} />
                          </div>
                        </div>
                        <div className="col-span-5">
                          <div className="text-sm font-medium text-gray-600 leading-relaxed">
                            <HighlightText text={process.description} highlight={searchTerm} />
                          </div>
                        </div>
                        <div className={`col-span-2 flex justify-end gap-2 transition-opacity ${selectedIds.includes(process.id) ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                          {canWrite && (
                            <button 
                              onClick={() => handleOpenEdit(process)}
                              className="h-8 w-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-blue-500 hover:bg-blue-50 transition-all"
                              title="Editar"
                              type="button"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                          )}
                          {canDelete && (
                            <button 
                              onClick={() => handleDelete(process.id)}
                              className="h-8 w-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 transition-all"
                              title="Excluir"
                              type="button"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                            </button>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center h-80 text-center">
                    <div className="bg-gray-50 rounded-full p-6 mb-4">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-gray-300"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                    </div>
                    <div className="text-gray-400 font-bold text-xs uppercase tracking-widest mb-1">
                      Nenhum registro encontrado
                    </div>
                    <p className="text-[10px] text-gray-300 font-medium">
                      Utilize o botão "Novo Registro" para começar
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Modal Form (Create/Edit) - MOVED OUTSIDE THE ANIMATED CONTAINER */}
            {isModalOpen && canWrite && (
              <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-suga-dark/40 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-white/50 transform transition-all scale-100">
                  <div className="bg-suga-dark px-6 py-5 flex justify-between items-center border-b border-white/10">
                    <h2 className="text-white font-bold text-sm uppercase tracking-widest">
                      {editingId ? 'Editar Registro' : 'Novo Registro de Processo'}
                    </h2>
                    <button 
                      type="button"
                      onClick={() => setIsModalOpen(false)} 
                      className="text-white/50 hover:text-white transition-colors bg-white/10 hover:bg-white/20 rounded-lg p-1"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                  </div>
                  
                  <form onSubmit={handleSave} className="p-8 space-y-6">
                    <div className="grid grid-cols-2 gap-6">
                      <div>
                        <label className="block text-[10px] font-extrabold text-gray-400 uppercase mb-2 tracking-widest">Data do Registro</label>
                        <input
                          type="date"
                          required
                          value={formData.data}
                          onChange={(e) => setFormData({...formData, data: e.target.value})}
                          className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-suga-medium/50 focus:border-suga-medium font-semibold text-gray-700 transition-all"
                        />
                      </div>
                      <div>
                        <label className="block text-[10px] font-extrabold text-gray-400 uppercase mb-2 tracking-widest">Número NUP</label>
                        <input
                          type="text"
                          required
                          placeholder="00000.000000/0000-00"
                          value={formData.nup}
                          onChange={(e) => setFormData({...formData, nup: e.target.value})}
                          className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-suga-medium/50 focus:border-suga-medium font-semibold text-gray-700 transition-all font-mono"
                        />
                      </div>
                    </div>
                    
                    <div>
                      <label className="block text-[10px] font-extrabold text-gray-400 uppercase mb-2 tracking-widest">Descrição detalhada</label>
                      <textarea
                        required
                        rows={4}
                        placeholder="Insira os detalhes do processo aqui..."
                        value={formData.description}
                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                        className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-suga-medium/50 focus:border-suga-medium font-medium text-gray-700 resize-none transition-all"
                      />
                    </div>

                    <div className="pt-4 flex gap-3 justify-end border-t border-gray-50 mt-4">
                      <button
                        type="button"
                        onClick={() => setIsModalOpen(false)}
                        className="px-5 py-3 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors uppercase tracking-wider"
                      >
                        Cancelar
                      </button>
                      <button
                        type="submit"
                        className="px-8 py-3 rounded-xl text-xs font-bold text-white bg-suga-dark hover:bg-suga-medium transition-all transform active:scale-95 uppercase tracking-wider shadow-lg shadow-emerald-900/10 flex items-center gap-2"
                      >
                        {editingId ? 'Salvar Alterações' : 'Confirmar Registro'}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )}
          </div>
        );
      };

      // 8. Layout Component
      const Layout = ({ children, user, currentView, onLogout, navigate }) => {
        if (currentView === 'login') {
          return (
            <div className="min-h-screen flex flex-col justify-between">
              <div className="flex-grow flex items-center justify-center p-4">
                {children}
              </div>
              <Footer />
            </div>
          );
        }

        return (
          <div className="min-h-screen flex flex-col bg-suga-light">
            {/* Header */}
            <header className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm">
              <div className="flex items-center gap-3 cursor-pointer" onClick={() => navigate('dashboard')}>
                <div className="bg-suga-dark text-white font-bold p-1 rounded px-2 text-sm">SUGA</div>
                <div className="flex items-center text-suga-dark font-bold text-sm tracking-wide">
                  SISTEMA UNIFICADO DE GESTÃO ADMINISTRATIVA
                </div>
              </div>
              
              <div className="flex items-center gap-4">
                <div className="text-right hidden sm:block">
                  <div className="text-xs text-gray-500">OLÁ, <span className="text-green-600 font-bold uppercase">{user?.role || 'USUÁRIO'}</span></div>
                  <div className="text-[10px] text-gray-400 font-medium">{user?.email || 'ADMIN'}</div>
                </div>
                <div className="h-8 w-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-800 font-bold text-sm">
                  {user?.email?.charAt(0).toUpperCase() || 'A'}
                </div>
                <button 
                  onClick={onLogout}
                  className="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-2 px-4 rounded transition-colors"
                >
                  SAIR
                </button>
              </div>
            </header>

            {/* Main Content */}
            <main className="flex-grow p-6 overflow-auto">
              <div className="max-w-7xl mx-auto">
                {children}
              </div>
            </main>

            <Footer />
          </div>
        );
      };

      // 9. Main App Component
      const App = () => {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);
        const [currentView, setCurrentView] = useState('login');

        useEffect(() => {
          const unsubscribe = onAuthStateChanged(auth, async (authUser) => {
            if (authUser) {
              // Regra alterada: Todos os usuários recebem nível de admin
              const userRole = 'admin';
              
              /*
              let userRole = 'convidado'; // Role padrão se não encontrar
              
              try {
                // Busca o documento do usuário na coleção 'users' usando o email como chave
                const userRef = doc(db, 'users', authUser.email);
                const snap = await userRef.get();
                
                if (snap.exists) {
                  const data = snap.data();
                  if (data && data.role) {
                    userRole = data.role;
                    console.log("Acesso concedido com cargo:", userRole);
                  }
                }
              } catch (error) {
                console.error("Erro ao verificar permissões:", error);
              }
              */

              setUser({
                name: authUser.displayName || 'Usuário',
                email: authUser.email,
                role: userRole
              });

              if (currentView === 'login') {
                setCurrentView('dashboard');
              }
            } else {
              setUser(null);
              setCurrentView('login');
            }
            setLoading(false);
          });

          return () => unsubscribe();
        }, [currentView]);

        const handleLogout = async () => {
          try {
            await signOut(auth);
            setCurrentView('login');
          } catch (error) {
            console.error("Error signing out", error);
          }
        };

        const navigate = (view) => {
          setCurrentView(view);
        };

        if (loading) {
          return (
            <div className="min-h-screen bg-suga-light flex items-center justify-center">
              <div className="animate-pulse flex flex-col items-center">
                <div className="h-12 w-12 bg-suga-dark rounded-lg mb-4"></div>
                <div className="h-4 w-32 bg-gray-200 rounded"></div>
              </div>
            </div>
          );
        }

        return (
          <Layout 
            user={user} 
            currentView={currentView} 
            onLogout={handleLogout}
            navigate={navigate}
          >
            {currentView === 'login' && <Login />}
            {currentView === 'dashboard' && <Dashboard navigate={navigate} />}
            {currentView === 'personnel' && <PersonnelList navigate={navigate} />}
            {currentView === 'processes' && <ProcessSuite navigate={navigate} user={user} />}
          </Layout>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>